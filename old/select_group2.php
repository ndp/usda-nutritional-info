<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"        "http://www.w3.org/TR/1999/REC-html401-19991224/loose.dtd"><!-- 	Copyright (c) 2001 by Andrew J. Peterson. All Rights Reserved.	ndp@mac.com / ndpsoftware.com / 4104 24th St. #202 SF CA 94114	Distribution, publication, or any other usage is strictly prohibited, 	without written permission from the author. --><html>	<head>		<title> Select from Food Group  </title>	</head>	<body bgcolor="#ffffcc"><?	$group	= $HTTP_GET_VARS['fdgp_cd'];	$prefix	= $HTTP_GET_VARS['prefix'];	$searchfor	= $HTTP_GET_VARS['searchfor'];	$commas	= $HTTP_GET_VARS['commas'] + 1;	$kMinRows = 3;	$kMaxRows = 20;	$kMaxCommas = 5;	$kNarrowURL = "select_group2.php";	$kResultURL = "select_food.php";		// Build a reusable "where" clause.	$where_clause = "";	if (strlen($group))	{		$where_clause = "WHERE FdGp_Cd=$group ";	}	if (strlen($prefix) > 0)	{		$where_clause .= strlen($where_clause) ? "AND " : "WHERE ";		$where_clause .= "Description LIKE \"$prefix%\" "; 	}	if (strlen($searchfor) > 0)	{		$where_clause .= strlen($where_clause) ? "AND " : "WHERE ";		$where_clause .= "Description LIKE \"%$searchfor%\"";	}			$conn 	= mysql_connect('localhost', 'mysql', 'mysql');	$db 	= mysql_select_db('usda', $conn);		if (!strlen($where_clause))	{		$sql = "SELECT * FROM FD_GROUP ORDER BY FdGp_Desc"; 		$result = mysql_query ($sql, $conn);?><h1>Please select a food group:</h1><ul><? while ($row = mysql_fetch_row($result)) { ?>			<li><a href=<? echo "\"".$kNarrowURL."?fdgp_cd=$row[0]\""; ?>><? echo $row[1]; ?></a>			</li><? } ?>		</ul>		<?php		}	else	{				// First, see if we have narrowed it down to a reasonable number.		$sql 	= "SELECT COUNT(*) FROM FOOD_DES $where_clause"; 		//print "<br>SQL QUERY<br>".$sql."<br>";		$result = mysql_query ($sql, $conn);		$row 	= mysql_fetch_row($result);		$countAll = $row[0];		if ($countAll < $kMaxRows)		{			$commas = 20; // Get the whole description		}				$done=0;			while ($done==0)		{			// If we have iterated enough, simply list all the available items.			if ($commas > $kMaxCommas)			{				$sql 	= "SELECT Description, Description, 1, ndb_no, 0 FROM FOOD_DES $where_clause ORDER BY Description"; 				$result = mysql_query ($sql, $conn);				$done=1;			}			else			{				$sql 	= "SELECT Description, SUBSTRING_INDEX(Description,\",\",$commas), COUNT(*), ndb_no, $commas FROM FOOD_DES $where_clause GROUP BY SUBSTRING_INDEX(Description,\",\",$commas) ORDER BY Description"; 				$result = mysql_query ($sql, $conn);				if (mysql_num_rows($result) < $kMinRows)				{					$commas++;				}				else				{					$done=1;				}			}		}				if (strlen($prefix))		{			echo "<h3>$prefix:</h3>\n<ul>\n";		}			while ($row = mysql_fetch_row($result)) 		{			$count = $row[2];						 // If we have a unique name, show it all. Otherwise, show the unique part that			 // groups several together.			$uniqueName = $row[($count == 1 ? 0 : 1)];									// If everything in the list uses a prefix, don't bother repeating it.			if (strlen($prefix) > 0)			{				$uniqueName = substr($uniqueName, strlen($prefix)+1, strlen($uniqueName));			}						// If the user has specified a search string, hilight it for her.			if (strlen($searchfor))			{				if (preg_match('/^(.*)('.$searchfor.')(.*)$/i', $uniqueName, $subpatterns))				{					$uniqueName = $subpatterns[1]."<b>".$subpatterns[2]."</b>".$subpatterns[3];				}			}						echo "<li>";			echo "<a href=\"";			// If there's only one food in the group, then go to the nutritional analysis.			// Otherwise, drill down to the next set of ,s 			// NOTE: Will this terminate?						if ($count == 1)			{				echo $kResultURL."?ndb_no=$row[3]";				echo "\">$uniqueName</a>"; // Give them the whole thing			}			else			{				echo $kNarrowURL."?fdgp_cd=$group&prefix=";				echo rawurlencode($row[1]);				echo "&commas=$commas";				if (strlen($searchfor)) echo "&searchfor=".urlencode($searchfor);				echo "\">$uniqueName <sup>$count</sup></a>"; // Give them what is left after the ","			}			echo "</li>\n";		}	}?>	</ul></body></html>